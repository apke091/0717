{% extends "base.html" %}
{% block title %}{{ review.title }}｜課程回顧{% endblock %}

{% block content %}
<div class="container" style="margin-top:90px; max-width:980px">

  <!-- 返回與標題列 -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <a class="btn btn-outline-secondary btn-sm btn-icon" href="{{ url_for('reviews') }}">
        <i class="bi bi-arrow-left"></i> 回列表
    </a>
    {% if session.get('role') == 'admin' %}
      <a class="btn btn-outline-secondary btn-sm btn-icon" href="{{ url_for('admin_review_edit', rid=review.id) }}">
        <i class="bi bi-pencil-square"></i> 後台編輯
      </a>
    {% endif %}
  </div>

  <!-- Hero / 封面 -->
  {% if review.cover_path %}
    <div class="hero mb-4 position-relative">
      <img src="{{ url_for('serve_upload', relpath=review.cover_path) }}" alt="{{ review.title }}"
           style="width:100%;height:360px;object-fit:cover;border-radius:14px;">
      <div class="position-absolute bottom-0 start-0 end-0 p-3" style="background:linear-gradient(180deg,transparent,rgba(0,0,0,.55)); border-bottom-left-radius:14px;border-bottom-right-radius:14px;">
        <h1 class="mb-1 text-white">{{ review.title }}</h1>
        <div class="d-flex gap-2 mt-2">
          {% if review.category_name %}
            <span class="badge-soft">#{{ review.category_name }}</span>
          {% endif %}
          {% if review.event_date %}
            <span class="badge-soft"><i class="bi bi-calendar-event"></i> {{ review.event_date }}</span>
          {% endif %}
          {% if review.status %}
            {% if review.status == 'published' %}
              <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-3 py-2">published</span>
            {% else %}
              <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-3 py-2">draft</span>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  {% else %}
    <div class="form-card mb-4">
      <h2 class="mb-2">{{ review.title }}</h2>
      <div class="d-flex flex-wrap gap-2">
        {% if review.category_name %}
          <span class="badge-soft">#{{ review.category_name }}</span>
        {% endif %}
        {% if review.event_date %}
          <span class="badge-soft"><i class="bi bi-calendar-event"></i> {{ review.event_date }}</span>
        {% endif %}
        {% if review.status %}
          {% if review.status == 'published' %}
            <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-3 py-2">published</span>
          {% else %}
            <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-3 py-2">draft</span>
          {% endif %}
        {% endif %}
      </div>
    </div>
  {% endif %}

  <!-- 內文標題（可留可刪） -->
  <h3 class="fw-bold mb-2">{{ review.title or '未命名回顧' }}</h3>
  <div class="text-muted small mb-3">
    {{ (review.event_date or review.created_at)|strftime("%Y-%m-%d") }} ・ {{ review.category_name }}
  </div>

  <!-- 圖庫（單一版本；支援 srcset 480/960、lazy、Lightbox） -->
  {% if media_list %}
    <style>
      .gallery-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
      .thumb-card{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px;height:100%;transition:.15s ease;box-shadow:0 6px 16px rgba(0,0,0,.04)}
      .thumb-card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.06)}
      .thumb-img,.thumb-video{width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:8px;display:block}
      .thumb-name{margin-top:8px;font-size:.88rem;color:#3b4455;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.6em;text-align:center;word-break:break-all}
    </style>

    <div class="gallery-grid">
      {% for m in media_list %}
      <div class="thumb-card">
        {% if m.mime and m.mime.startswith('image/') %}
          <a class="text-decoration-none"
             href="{{ url_for('serve_upload', relpath=m.file_path) }}"
             data-index="{{ loop.index0 }}"
             data-src="{{ url_for('serve_upload', relpath=m.file_path) }}"
             data-name="{{ m.file_name }}"
             onclick="openLightbox(event)">
            <img class="thumb-img" loading="lazy"
                 src="{{ url_for('serve_upload', relpath=m.file_path_480 or m.file_path) }}"
                 srcset="
                   {% if m.file_path_480 %}{{ url_for('serve_upload', relpath=m.file_path_480) }} 480w,{% endif %}
                   {% if m.file_path_960 %}{{ url_for('serve_upload', relpath=m.file_path_960) }} 960w,{% endif %}
                   {{ url_for('serve_upload', relpath=m.file_path) }} 1600w"
                 sizes="(max-width: 576px) 50vw, (max-width: 992px) 33vw, 20vw"
                 alt="{{ m.file_name or (review.title ~ ' 圖片') }}">
            <div class="thumb-name">{{ m.file_name or '未命名' }}</div>
          </a>
        {% elif m.mime and m.mime.startswith('video/') %}
          <a class="text-decoration-none" href="{{ url_for('serve_upload', relpath=m.file_path) }}" target="_blank">
            <video class="thumb-video" muted preload="metadata">
              <source src="{{ url_for('serve_upload', relpath=m.file_path) }}" type="{{ m.mime }}">
            </video>
            <div class="thumb-name">{{ m.file_name or '未命名' }}</div>
          </a>
        {% else %}
          <div class="text-center">
            <div class="d-flex align-items-center justify-content-center" style="height: calc((160px*3)/4);">
              <i class="bi bi-file-earmark-text" style="font-size:2rem;"></i>
            </div>
            <div class="thumb-name">{{ m.file_name or '未命名' }}</div>
            <a class="btn btn-sm btn-outline-primary w-100"
               href="{{ url_for('serve_upload', relpath=m.file_path) }}" target="_blank">開啟</a>
          </div>
        {% endif %}

        {% if session.get('role') == 'admin' %}
        <form method="POST"
              action="{{ url_for('admin_delete_review_media', rid=review.id, mid=m.id) }}"
              onsubmit="return confirm('確定刪除？')">
          <button class="btn btn-sm btn-outline-danger w-100 mt-1" type="submit">刪除</button>
        </form>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center text-muted py-5">尚未上傳任何媒體。</div>
  {% endif %}

  <!-- 底部操作 -->
  <div class="d-flex align-items-center justify-content-between mt-4">
    <a class="btn btn-outline-secondary btn-sm btn-icon" href="{{ url_for('reviews') }}">
        <i class="bi bi-arrow-left"></i> 回列表
    </a>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm btn-icon" href="javascript:window.scrollTo({top:0,behavior:'smooth'})">
        <i class="bi bi-arrow-up-short"></i> 回到頂部
      </a>
      {% if session.get('role') == 'admin' %}
      <a class="btn btn-outline-secondary btn-sm btn-icon" href="{{ url_for('admin_review_edit', rid=review.id) }}">
        <i class="bi bi-pencil-square"></i> 後台編輯
      </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Lightbox（Bootstrap Modal） -->
<div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" style="background:#0b0b0c;">
      <div class="modal-body p-0 position-relative">
        <img id="lbImg" alt="" style="width:100%;height:auto;display:block;max-height:85vh;object-fit:contain;">
        <button type="button" class="btn btn-light position-absolute top-0 end-0 m-2" data-bs-dismiss="modal" aria-label="Close">✕</button>
        <button type="button" class="btn btn-dark position-absolute top-50 start-0 translate-middle-y ms-2" onclick="navLightbox(-1)" aria-label="上一張">‹</button>
        <button type="button" class="btn btn-dark position-absolute top-50 end-0 translate-middle-y me-2" onclick="navLightbox(1)" aria-label="下一張">›</button>
      </div>
      <div class="modal-footer justify-content-between text-white border-0">
        <div id="lbName" class="small text-truncate"></div>
        <a id="lbOpen" class="btn btn-outline-light btn-sm" href="#" target="_blank" rel="noopener">在新分頁開啟</a>
      </div>
    </div>
  </div>
</div>

<script>
  let lbIndex = 0;
  function openLightbox(e){
    e.preventDefault();
    const a = e.currentTarget;
    lbIndex = parseInt(a.dataset.index || 0, 10);
    setLightbox(a.dataset.src, a.dataset.name);
    new bootstrap.Modal('#lightboxModal').show();
  }
  function setLightbox(src, name){
    const img = document.getElementById('lbImg');
    const nm  = document.getElementById('lbName');
    const open= document.getElementById('lbOpen');
    img.src = src; nm.textContent = name || '';
    open.href = src;
  }
  function navLightbox(step){
    const thumbs = Array.from(document.querySelectorAll('.thumb-card a[data-src]'));
    if(!thumbs.length) return;
    lbIndex = (lbIndex + step + thumbs.length) % thumbs.length;
    const a = thumbs[lbIndex];
    setLightbox(a.dataset.src, a.dataset.name);
  }
  document.addEventListener('keydown', (ev)=>{
    const modal = document.getElementById('lightboxModal');
    if(!modal.classList.contains('show')) return;
    if(ev.key === 'ArrowLeft') navLightbox(-1);
    if(ev.key === 'ArrowRight') navLightbox(1);
  });
</script>
{% endblock %}
