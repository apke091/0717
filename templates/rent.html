{% extends "base.html" %}
{% block title %}教室租借{% endblock %}

{% block content %}
<div class="container" style="margin-top: 90px">
  <h1>教室租借資訊</h1>
  <p>本會提供場地租借服務，適合小型課程與講座使用。</p>
  <ul>
      <li>【府前教室】</li>
      <li>台南市中西區府前路一88號9樓</li>
      <li>06-2228504</li>
      <li>租借費用：$500/小時</li>
  </ul>
  <ul>
      <li>【西門教室】</li>
      <li>台南市北區西門路三段159號9樓5</li>
      <li>06-2226607</li>
      <li>租借費用：$500/小時</li>
  </ul>
  <p>請聯絡本會辦公室預約。</p>

  <hr>
  <h2>線上申請租借</h2>
  <!-- ✅ onsubmit 會檢查日期三欄是否完整 -->
  <form method="POST" onsubmit="return validateDate();">
    <div class="mb-3">
      <label class="form-label">選擇場地</label>
      <select class="form-select" name="location" id="location" required>
        <option value="">請選擇</option>
        <option value="府前教室">府前教室</option>
        <option value="西門教室">西門教室</option>
      </select>
    </div>

    <!-- ✅ 三欄式日期（年 / 月 / 日） -->
    <div class="mb-3">
      <label class="form-label">租借日期</label>
      <div class="row g-2">
        <div class="col-4">
          <select id="date_year" class="form-select">
            <option value="">年</option>
          </select>
        </div>
        <div class="col-4">
          <select id="date_month" class="form-select" disabled>
            <option value="">月</option>
          </select>
        </div>
        <div class="col-4">
          <select id="date_day" class="form-select" disabled>
            <option value="">日</option>
          </select>
        </div>
      </div>
      <!-- 送到後端的實際欄位（YYYY-MM-DD） -->
      <input type="hidden" name="date" id="date_hidden">
      <div id="dateHelp" class="form-text">過去與「已滿」日期會自動不可選；選好年月日後會帶出可用時段。</div>
    </div>

    <div class="mb-3">
      <label class="form-label">租借時段</label>
      <select class="form-select" name="time_slot" id="time_slot" required disabled>
        <option value="">請先選擇日期</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">聯絡人姓名</label>
      <input type="text" class="form-control" name="name" required>
    </div>

    <div class="mb-3">
      <label class="form-label">聯絡電話（手機）</label>
      <input type="text" class="form-control" name="phone" pattern="09\d{8}" required>
    </div>

    <div class="mb-3">
      <label class="form-label">電子郵件</label>
      <input type="email" class="form-control" name="email" required>
    </div>

    <div class="mb-3">
      <label class="form-label">備註</label>
      <textarea class="form-control" name="note" rows="3"></textarea>
    </div>

    <button type="submit" class="btn btn-primary" id="submitBtn">送出申請</button>
  </form>
</div>

<!-- ✅ 純原生 JS：依「場地」取已滿日期、依「日期」取可用時段 -->
<script>
  // 抓元素
  const $loc   = document.getElementById('location');
  const $slot  = document.getElementById('time_slot');
  const $y     = document.getElementById('date_year');
  const $m     = document.getElementById('date_month');
  const $d     = document.getElementById('date_day');
  const $hid   = document.getElementById('date_hidden');

  // 今天（從後端來，避免時區亂掉）
  const TODAY_STR = "{{ now.strftime('%Y-%m-%d') }}";
  const TODAY = new Date(TODAY_STR + "T00:00:00");

  // 已滿日期（同日三時段皆滿）：'YYYY-MM-DD'
  let disabledSet = new Set();

  // 工具
  const pad2 = n => String(n).padStart(2, '0');
  const daysInMonth = (y, m) => new Date(y, m, 0).getDate(); // m=1..12

  function isPast(y, m, d) {
    if (!y || !m || !d) return false;
    const dt = new Date(`${y}-${pad2(m)}-${pad2(d)}T00:00:00`);
    return dt < TODAY;
  }

  // 依年份填月份（若為當年，只給 >= 今月）
  function populateMonths() {
    const y = parseInt($y.value, 10);
    $m.innerHTML = '<option value="">月</option>';
    $m.disabled = !y;
    if (!y) return;

    const startMonth = (y === TODAY.getFullYear()) ? (TODAY.getMonth() + 1) : 1;
    for (let mm = startMonth; mm <= 12; mm++) {
      $m.append(new Option(mm, mm));
    }
  }

  // 依年/月填日；過去 & 已滿 → disabled
  function populateDays() {
    const y = parseInt($y.value, 10);
    const m = parseInt($m.value, 10);
    $d.innerHTML = '<option value="">日</option>';
    $d.disabled = !(y && m);
    if (!(y && m)) return;

    const dim = daysInMonth(y, m);
    let hasSelectable = false;

    for (let dd = 1; dd <= dim; dd++) {
      const dateStr = `${y}-${pad2(m)}-${pad2(dd)}`;
      const txt = disabledSet.has(dateStr) ? `${dd}（已滿）` : dd;
      const opt = new Option(txt, dd);
      if (isPast(y, m, dd) || disabledSet.has(dateStr)) {
        opt.disabled = true;
      } else {
        hasSelectable = true;
      }
      $d.append(opt);
    }

    if (!hasSelectable) {
      const opt = new Option('（此年月無可選日期）', '');
      opt.disabled = true;
      $d.append(opt);
    }
  }

  // 年份：今年 ~ 明年（可自行調整）
  function populateYears() {
    const startY = TODAY.getFullYear();
    const endY = startY + 1;
    $y.innerHTML = '<option value="">年</option>';
    for (let yy = startY; yy <= endY; yy++) {
      $y.append(new Option(yy, yy));
    }
  }

  // 寫入隱藏欄位 + 取可用時段
  async function commitDateAndFetchSlots() {
    const y = parseInt($y.value, 10);
    const m = parseInt($m.value, 10);
    const d = parseInt($d.value, 10);
    if (!(y && m && d)) {
      $hid.value = '';
      $slot.innerHTML = '<option value="">請先選擇日期</option>';
      $slot.disabled = true;
      return;
    }

    const dateStr = `${y}-${pad2(m)}-${pad2(d)}`;
    $hid.value = dateStr;

    const loc = ($loc.value || '').trim();
    if (!loc) {
      $slot.innerHTML = '<option value="">請先選擇場地</option>';
      $slot.disabled = true;
      return;
    }

    const res = await fetch(`/api/rent/available_slots?location=${encodeURIComponent(loc)}&date=${encodeURIComponent(dateStr)}`);
    const data = await res.json();
    const available = data.available || [];

    $slot.innerHTML = '';
    if (available.length === 0) {
      $slot.append(new Option('（此日無可用時段，請換日期）', ''));
      $slot.disabled = true;
    } else {
      $slot.append(new Option('請選擇', ''));
      for (const s of available) $slot.append(new Option(s, s));
      $slot.disabled = false;
    }
  }

  // 場地改變 → 重抓滿額日、重建月份/日期
  async function refreshDisabledDates() {
    const loc = ($loc.value || '').trim();
    disabledSet = new Set();
    if (loc) {
      const res = await fetch(`/api/rent/disabled_dates?location=${encodeURIComponent(loc)}`);
      const data = await res.json();
      (data.disabled_dates || []).forEach(d => disabledSet.add(d));
    }
    populateMonths();
    populateDays();
    // 變更場地時清掉已選日與時段
    $d.value = '';
    $hid.value = '';
    $slot.innerHTML = '<option value="">請先選擇日期</option>';
    $slot.disabled = true;
  }

  // 表單送出前檢查（hidden 不會被瀏覽器 required 驗證）
  function validateDate() {
    if (!$hid.value) {
      alert('請先選擇完整的租借日期（年 / 月 / 日）');
      return false;
    }
    if (!$slot.value) {
      alert('請選擇租借時段');
      return false;
    }
    return true;
  }

  // 綁定事件
  $y.addEventListener('change', () => { populateMonths(); populateDays(); commitDateAndFetchSlots(); });
  $m.addEventListener('change', () => { populateDays(); commitDateAndFetchSlots(); });
  $d.addEventListener('change', commitDateAndFetchSlots);
  $loc.addEventListener('change', refreshDisabledDates);

  // 初始化
  populateYears();
  refreshDisabledDates();
</script>
{% endblock %}
