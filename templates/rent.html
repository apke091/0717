{% extends "base.html" %}
{% block title %}線上申請租借{% endblock %}

{% block content %}

<!-- Flatpickr（時間選擇器） -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>

<style>
  .rent-card { border:0; border-radius:18px; box-shadow:0 12px 30px rgba(83,70,186,.08); }
  .rent-header{
    border-bottom:0; padding:28px 28px 10px;
    background:linear-gradient(135deg, rgba(131,93,255,.10), rgba(255,255,255,0));
    border-top-left-radius:18px; border-top-right-radius:18px;
  }
  .rent-title{ font-weight:800; letter-spacing:.5px; }
  .form-label{ font-weight:600; color:#3d3d53; }
  .form-select,.form-control{ border-radius:12px; }
  .form-select:focus,.form-control:focus{ box-shadow:0 0 0 .2rem rgba(131,93,255,.18); border-color:#835dff; }
  .hint{ color:#6b6b82; font-size:.9rem; }
  .rent-card .btn-primary{
    background:#9a8cf2; border-color:#9a8cf2; border-radius:12px; padding:.6rem 1.1rem; color:#fff;
  }
  .rent-card .btn-primary:hover{ background:#8e80ec; border-color:#8e80ec; }
  .rent-card .btn-primary:active{ background:#8376e6; border-color:#8376e6; }
  .rent-card .btn-primary:focus-visible{ outline:none; box-shadow:0 0 0 .2rem rgba(154,140,242,.28); }
  #email-suggestions { max-height: 180px; overflow-y: auto; }
  .flatpickr-input.form-control { background:#fff; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.06) inset; }
  .flatpickr-calendar { border-radius:14px; box-shadow:0 16px 40px rgba(90,80,200,.18); }
</style>

{# ✅ 改動：拿掉 margin-top:90px（因為全站已經有預留 navbar 高度） #}
{# ✅ 改動：不要再包 container-fluid/row/col，避免多餘留白與版型打架 #}
<div class="d-flex justify-content-center">
  <div class="w-100" style="max-width:980px;">
    <div class="card rent-card">
      <div class="rent-header">
        <h2 class="rent-title mb-1">線上申請租借</h2>
        <div class="hint">選擇教室、日期與時間。</div>
      </div>

      <div class="card-body p-4 p-md-5">
        <form id="rentForm" novalidate method="POST" action="{{ url_for('rent') }}">
          <!-- 教室 -->
          <div class="mb-3">
            <label class="form-label" for="location">教室</label>
            <select class="form-select" id="location" name="location" required>
              <option value="" selected disabled>請選擇教室</option>
              <option>府前教室</option>
              <option>西門教室</option>
            </select>
          </div>

          <!-- 日期（年/月/日選單） -->
          <div class="mb-2">
            <label class="form-label">租借日期</label>
            <div class="d-flex gap-2">
              <select id="yyyy" class="form-select" style="max-width:130px;"></select>
              <select id="mm"   class="form-select" style="max-width:110px;"></select>
              <select id="dd"   class="form-select" style="max-width:110px;"></select>
            </div>
            <div class="hint mt-1">僅可選擇今天（含）以後的日期。</div>
            <input type="hidden" id="date" name="date" required>
          </div>

          <!-- 時間（Flatpickr，允許手打） -->
          <div class="mb-3">
            <label class="form-label">租借時間</label>
            <div class="row g-2">
              <div class="col-6">
                <input type="text" name="start_time" class="form-control js-time"
                       placeholder="開始（如 09:00）" required>
              </div>
              <div class="col-6">
                <input type="text" name="end_time" class="form-control js-time"
                       placeholder="結束（如 12:00）" required>
              </div>
            </div>
            <div class="hint">開放 09:00–21:30；結束需晚於開始。</div>
          </div>

          <!-- 申請人 -->
          <div class="mb-3">
            <label class="form-label">申請人</label>
            <input id="name" name="name" class="form-control" placeholder="請輸入您的名字" required>
            <div class="invalid-feedback">請輸入申請人姓名</div>
          </div>

          <!-- 電話 -->
          <div class="mb-3">
            <label class="form-label">電話</label>
            <input id="phone" name="phone" class="form-control"
                   placeholder="09xx-xxx-xxx" required inputmode="tel"
                   pattern="^09\\d{2}-?\\d{3}-?\\d{3}$" maxlength="12">
            <div class="form-text">僅接受台灣手機：09xx-xxx-xxx（可不輸入連字號）。</div>
            <div class="invalid-feedback">請輸入正確的手機號碼（09xx-xxx-xxx）</div>
          </div>

          <!-- Email -->
          <div class="mb-3 position-relative">
            <label class="form-label">Email</label>
            <input id="email" name="email" type="email" class="form-control"
                   placeholder="name@example.com" required inputmode="email"
                   pattern="^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$">
            <div class="invalid-feedback">請輸入正確的 Email</div>
            <ul id="email-suggestions"
                class="list-group position-absolute w-100 shadow-sm"
                style="z-index:1060; top:100%; left:0; display:none;">
            </ul>
          </div>

          <!-- 備註 -->
          <div class="mb-4">
            <label class="form-label">備註（選填）</label>
            <textarea name="note" rows="3" class="form-control" placeholder="有其他需求可在此說明"></textarea>
          </div>

          <div class="d-grid">
            <button id="submitBtn" class="btn btn-primary" type="submit">送出申請</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---- DOM ----
  const yyyy = document.getElementById('yyyy');
  const mm   = document.getElementById('mm');
  const dd   = document.getElementById('dd');
  const hiddenDate = document.getElementById('date');

  const form   = document.getElementById('rentForm');
  const nameI  = document.getElementById('name');
  const phoneI = document.getElementById('phone');
  const emailI = document.getElementById('email');
  const emailSug = document.getElementById('email-suggestions');

  // ---- Utils ----
  const today = new Date();
  const TY = today.getFullYear(), TM = today.getMonth() + 1, TD = today.getDate();
  const pad2 = n => String(n).padStart(2,'0');
  const daysInMonth = (y, m) => new Date(y, m, 0).getDate();

  // 年：今年 ~ +2
  for (let y = TY; y <= TY + 2; y++) yyyy.add(new Option(y, y));

  function rebuildMonths() {
    const y = Number(yyyy.value);
    mm.innerHTML = '';
    const startM = (y === TY) ? TM : 1;
    for (let m = startM; m <= 12; m++) mm.add(new Option(pad2(m), pad2(m)));
    if (mm.options.length) mm.value = mm.options[0].value;
  }

  function rebuildDays() {
    const y = Number(yyyy.value);
    const m = Number(mm.value);
    dd.innerHTML = '';
    if (!y || !m) return;

    const startD = (y === TY && m === TM) ? TD : 1;
    const dim = daysInMonth(y, m);

    let first = '';
    for (let d = startD; d <= dim; d++) {
      const opt = new Option(pad2(d), pad2(d));
      dd.add(opt);
      if (!first) first = opt.value;
    }
    dd.value = first || '';
    hiddenDate.value = dd.value ? `${y}-${pad2(m)}-${dd.value}` : '';
  }

  // ====== 前端驗證（電話/Email） ======
  const PHONE_RE = /^09\d{2}-?\d{3}-?\d{3}$/;
  const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  let triedSubmit = false;
  const mark = (el, ok) => el && el.classList.toggle('is-invalid', !ok);

  function validateAndMark() {
    const ok = {
      name: !!nameI?.value.trim(),
      phone: PHONE_RE.test((phoneI?.value || '').trim()),
      email: EMAIL_RE.test((emailI?.value || '').trim()),
      date: !!hiddenDate.value && !!dd.value
    };
    if (triedSubmit) {
      mark(nameI, ok.name); mark(phoneI, ok.phone); mark(emailI, ok.email);
    }
    return ok.name && ok.phone && ok.email && ok.date;
  }

  // 電話輸入即時格式化
  (function () {
    if (!phoneI) return;
    function fmt(d) {
      d = d.replace(/\D/g, '').slice(0, 10);
      if (d.length <= 4) return d;
      if (d.length <= 7) return d.slice(0,4)+'-'+d.slice(4);
      return d.slice(0,4)+'-'+d.slice(4,7)+'-'+d.slice(7);
    }
    phoneI.addEventListener('input', (e) => {
      const raw = e.target.value;
      const caret = e.target.selectionStart;
      const digits = raw.replace(/\D/g, '').slice(0, 10);
      const beforeDigitsLeft = raw.slice(0, caret).replace(/\D/g, '').length;
      const after = fmt(digits);
      let count = 0, pos = after.length;
      for (let i=0; i<after.length; i++) {
        if (/\d/.test(after[i])) {
          if (count === beforeDigitsLeft) { pos = i; break; }
          count++;
        }
      }
      e.target.value = after;
      e.target.setSelectionRange(pos, pos);
      if (triedSubmit) validateAndMark();
    });
  })();

  // Email 建議網域
  const emailDomains = ['gmail.com','yahoo.com','yahoo.com.tw','hotmail.com','hotmail.com.tw','outlook.com'];
  if (emailI && emailSug) {
    emailI.addEventListener('input', function () {
      const value = this.value;
      const atIndex = value.indexOf('@');
      if (atIndex === -1) { emailSug.style.display = 'none'; return; }
      const namePart = value.slice(0, atIndex);
      const typedDomain = value.slice(atIndex + 1).toLowerCase();
      const matches = emailDomains.filter(d => d.startsWith(typedDomain));
      if (!matches.length) { emailSug.style.display = 'none'; return; }
      emailSug.innerHTML = '';
      matches.forEach(domain => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.textContent = `${namePart}@${domain}`;
        li.addEventListener('mousedown', function (e) {
          e.preventDefault();
          emailI.value = this.textContent;
          emailSug.style.display = 'none';
          if (triedSubmit) validateAndMark();
        });
        emailSug.appendChild(li);
      });
      emailSug.style.display = 'block';
    });
    emailI.addEventListener('blur', () => setTimeout(() => emailSug.style.display = 'none', 150));
  }

  form.addEventListener('submit', (e) => {
    triedSubmit = true;
    if (!validateAndMark()) { e.preventDefault(); e.stopPropagation(); }
  });

  ['input','change'].forEach(evt => {
    [nameI, phoneI, emailI, yyyy, mm, dd].forEach(el => el?.addEventListener(evt, () => { if (triedSubmit) validateAndMark(); }));
  });

  // ---- 初始化：日期三選單 ----
  yyyy.value = TY; rebuildMonths(); rebuildDays();
  yyyy.addEventListener('change', () => { rebuildMonths(); rebuildDays(); });
  mm.addEventListener('change', rebuildDays);
  dd.addEventListener('change', () => {
    const y = Number(yyyy.value), m = Number(mm.value);
    hiddenDate.value = dd.value ? `${y}-${pad2(m)}-${dd.value}` : '';
  });

  // ================================
  // Flatpickr（09:00–21:30 / 15 分, 手動輸入 OK）
  // ================================
  const s = document.querySelector('input[name="start_time"]');
  const e = document.querySelector('input[name="end_time"]');

  // 解鎖手動輸入（避免某些環境被加 readonly）
  function unlockTyping(el){
    if (!el) return;
    el.readOnly = false; el.removeAttribute('readonly');
    el.setAttribute('autocomplete','off'); el.style.caretColor = 'auto';
  }
  function keepUnlocked(el){
    const mo = new MutationObserver(() => unlockTyping(el));
    mo.observe(el, { attributes:true, attributeFilter:['readonly'] });
  }

  const baseOpts = {
    enableTime:true, noCalendar:true, time_24hr:true,
    minuteIncrement:15, minTime:"09:00", maxTime:"21:30",
    allowInput:true, disableMobile:true, clickOpens:true,
    locale: window.flatpickr?.l10ns?.zh_tw || undefined
  };

  const startPicker = flatpickr(s, {
    ...baseOpts, defaultHour:9, defaultMinute:0,
    onReady(){ unlockTyping(s); keepUnlocked(s); },
    onOpen(){ unlockTyping(s); }, onClose(){ unlockTyping(s); },
    onChange(_, t){
      if (!t) return;
      const [hh, mm] = t.split(':').map(Number);
      const d = new Date(0,0,0,hh,mm+15);
      const minStr = String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
      endPicker.set('minTime', minStr);
      if (e.value && e.value < minStr) endPicker.setDate(minStr, true);
      e.setCustomValidity('');
    }
  });

  const endPicker = flatpickr(e, {
    ...baseOpts, defaultHour:10, defaultMinute:0,
    onReady(){ unlockTyping(e); keepUnlocked(e); },
    onOpen(){ unlockTyping(e); }, onClose(){ unlockTyping(e); },
    onValueUpdate(_, t){
      const sv = s.value; if (!sv || !t) return;
      e.setCustomValidity(t <= sv ? '結束時間必須晚於開始時間' : '');
    }
  });

  // 防止 Flatpickr 攔截鍵盤：確保能輸入
  [s,e].forEach(el=>{
    el.addEventListener('keydown', ev => ev.stopPropagation(), true);
    el.addEventListener('focus', () => unlockTyping(el));
  });

  // ===== 輸入合法化（09:00–21:30、15 分、結束 ≥ 開始+15） =====
  function hmToMin(str){ if(!str) return null; const m=String(str).trim().match(/^(\d{1,2}):?(\d{2})$/); if(!m) return null; const h=Math.min(99,parseInt(m[1],10)), mm=parseInt(m[2],10); if(isNaN(h)||isNaN(mm)||mm>59) return null; return h*60+mm; }
  function minToHM(min){ min=Math.max(0,Math.min(24*60-1,min)); const h=Math.floor(min/60), m=min%60; return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0'); }
  function snap(min, step=15){ return Math.round(min/step)*step; }

  const OPEN = hmToMin("09:00"), CLOSE = hmToMin("21:30"), STEP = 15;

  function normalize({fixEnd=true, snapToStep=false}={}){
    let sv = hmToMin(s.value), ev = hmToMin(e.value);

    if (sv!=null){ sv = Math.max(OPEN, Math.min(CLOSE, sv)); if (snapToStep) sv = snap(sv, STEP); s.value = minToHM(sv); }
    if (ev!=null){ ev = Math.max(OPEN, Math.min(CLOSE, ev)); if (snapToStep) ev = snap(ev, STEP); }
    if (fixEnd && sv!=null){ const minEnd = Math.min(CLOSE, sv + STEP); if (ev==null || ev < minEnd) ev = minEnd; }
    if (ev!=null) e.value = minToHM(ev);

    // 更新 flatpickr 的最小結束時間
    const minEndStr = minToHM(Math.min((sv??OPEN)+STEP, CLOSE));
    endPicker.set('minTime', minEndStr);

    s.setCustomValidity(sv!=null && sv>=OPEN && sv<=CLOSE ? '' : '時間需在 09:00–21:30 且為 15 分單位');
    e.setCustomValidity(ev!=null && ev>=OPEN && ev<=CLOSE && (sv==null || ev>=sv+STEP) ? '' : '結束時間需 ≥ 開始+15 分，且在 09:00–21:30');
  }

  // 分鐘兩位就自動貼齊
  function autoSnapIfMinuteDone(el){
    const m = String(el.value||'').match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return;
    normalize({fixEnd:true, snapToStep:true});
  }

  s.addEventListener('input',  ()=>{ s.setCustomValidity(''); normalize({fixEnd:false, snapToStep:false}); autoSnapIfMinuteDone(s); });
  e.addEventListener('input',  ()=>{ e.setCustomValidity(''); normalize({fixEnd:false, snapToStep:false}); autoSnapIfMinuteDone(e); });
  ['blur','change'].forEach(evt=>{
    s.addEventListener(evt, ()=> normalize({fixEnd:true,  snapToStep:true}));
    e.addEventListener(evt, ()=> normalize({fixEnd:true,  snapToStep:true}));
  });

  // 初始一次
  normalize();

  // 送出前最後把關
  form.addEventListener('submit', (ev)=>{
    normalize({fixEnd:true, snapToStep:true});
    if(!s.checkValidity() || !e.checkValidity()){
      ev.preventDefault(); ev.stopPropagation();
    }
  });
});
</script>
{% endblock %}
