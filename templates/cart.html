{% extends "base.html" %}
{% block title %}è³¼ç‰©è»Š{% endblock %}

{% block content %}
<div class="container" style="margin-top: 90px">
  <h2>ğŸ›’ è³¼ç‰©è»Š</h2>

  {% if items %}
  <form method="POST" action="{{ url_for('update_cart_qty') }}">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 60px;">
            <!-- å…¨é¸ / å…¨ä¸é¸ -->
            <input type="checkbox" id="checkAll" checked>
          </th>
          <th>å•†å“åç¨±</th>
          <th>å–®åƒ¹</th>
          <th style="width: 160px;">æ•¸é‡</th>
          <th>å°è¨ˆ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="cartBody">
        {% for item in items %}
        <tr data-price="{{ item.price }}">
          <td>
            <input type="checkbox" class="item-check" checked>
          </td>
          <td>{{ item.name }}</td>
          <td class="price-cell">{{ item.price }} å…ƒ</td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <input type="hidden" name="pid[]" value="{{ item.pid }}">
              <input type="number" name="qty[]" class="form-control qty-input" value="{{ item.quantity }}" min="1" step="1" required style="max-width: 110px;">
              <button type="button" class="btn btn-outline-secondary btn-sm btn-dec">ï¼</button>
              <button type="button" class="btn btn-outline-secondary btn-sm btn-inc">ï¼‹</button>
            </div>
          </td>
          <td class="subtotal-cell fw-semibold">â€”</td>
          <td>
            <a href="{{ url_for('remove_from_cart', pid=item.pid) }}" class="btn btn-sm btn-danger">ç§»é™¤</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4" class="text-end fw-bold">å‹¾é¸é …ç›®åˆè¨ˆï¼š</td>
          <td id="totalCell" class="fw-bold fs-5">â€”</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">æ›´æ–°æ•¸é‡</button>

      <form method="POST" action="{{ url_for('clear_cart') }}">
        <button type="submit" class="btn btn-outline-warning">æ¸…ç©ºè³¼ç‰©è»Š</button>
      </form>
    </div>
  </form>
  {% else %}
    <div class="alert alert-info">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œå»é€›é€›å§ï¼</div>
  {% endif %}
</div>

<!-- âœ… å‰ç«¯å‹•æ…‹è¨ˆç®—ï¼šåªæœ‰å‹¾é¸çš„æ‰è¨ˆå…¥ç¸½é‡‘é¡ï¼›æ•¸é‡è®Šå‹•å³æ™‚æ›´æ–°å°è¨ˆèˆ‡åˆè¨ˆ -->
<script>
  (function () {
    const body = document.getElementById('cartBody');
    if (!body) return;

    const checkAll = document.getElementById('checkAll');
    const totalCell = document.getElementById('totalCell');

    function formatCurrency(n) {
      return new Intl.NumberFormat('zh-TW').format(n) + ' å…ƒ';
    }

    function recalcRow(tr) {
      const price = parseInt(tr.getAttribute('data-price'), 10) || 0;
      const qtyInput = tr.querySelector('.qty-input');
      let qty = parseInt(qtyInput.value, 10) || 1;
      if (qty < 1) { qty = 1; qtyInput.value = 1; }
      const subtotal = price * qty;
      tr.querySelector('.subtotal-cell').textContent = formatCurrency(subtotal);
      return { subtotal, checked: tr.querySelector('.item-check').checked };
    }

    function recalcAll() {
      let total = 0;
      body.querySelectorAll('tr').forEach(tr => {
        const { subtotal, checked } = recalcRow(tr);
        if (checked) total += subtotal;
      });
      totalCell.textContent = formatCurrency(total);
    }

    // äº‹ä»¶ï¼šæ•¸é‡åŠ æ¸›æŒ‰éˆ•ã€è¼¸å…¥æ¡†ã€å‹¾é¸æ¡†ã€å…¨é¸
    body.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const tr = e.target.closest('tr');
      if (!tr) return;

      const qtyInput = tr.querySelector('.qty-input');
      let qty = parseInt(qtyInput.value, 10) || 1;

      if (btn.classList.contains('btn-inc')) {
        qtyInput.value = qty + 1;
        recalcAll();
      } else if (btn.classList.contains('btn-dec')) {
        qtyInput.value = Math.max(1, qty - 1);
        recalcAll();
      }
    });

    body.addEventListener('input', (e) => {
      if (e.target.classList.contains('qty-input')) {
        recalcAll();
      }
    });

    body.addEventListener('change', (e) => {
      if (e.target.classList.contains('item-check')) {
        recalcAll();
      }
    });

    if (checkAll) {
      checkAll.addEventListener('change', () => {
        const checked = checkAll.checked;
        body.querySelectorAll('.item-check').forEach(cb => cb.checked = checked);
        recalcAll();
      });
    }

    // é¦–æ¬¡è¼‰å…¥è¨ˆç®—
    recalcAll();
  })();
</script>
{% endblock %}
