{% extends "base.html" %}
{% block title %}購物車{% endblock %}

{% block content %}
<div class="container" style="margin-top: 90px">
  <h2>🛒 購物車</h2>

  {% if items %}
  <form method="POST" action="{{ url_for('update_cart_qty') }}">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 60px;">
            <!-- 全選 / 全不選 -->
            <input type="checkbox" id="checkAll" checked>
          </th>
          <th>商品名稱</th>
          <th>單價</th>
          <th style="width: 160px;">數量</th>
          <th>小計</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="cartBody">
        {% for item in items %}
        <tr data-price="{{ item.price }}">
          <td>
            <input type="checkbox" class="item-check" checked>
          </td>
          <td>{{ item.name }}</td>
          <td class="price-cell">{{ item.price }} 元</td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <input type="hidden" name="pid[]" value="{{ item.pid }}">
              <input type="number" name="qty[]" class="form-control qty-input" value="{{ item.quantity }}" min="1" step="1" required style="max-width: 110px;">
              <button type="button" class="btn btn-outline-secondary btn-sm btn-dec">－</button>
              <button type="button" class="btn btn-outline-secondary btn-sm btn-inc">＋</button>
            </div>
          </td>
          <td class="subtotal-cell fw-semibold">—</td>
          <td>
            <a href="{{ url_for('remove_from_cart', pid=item.pid) }}" class="btn btn-sm btn-danger">移除</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4" class="text-end fw-bold">勾選項目合計：</td>
          <td id="totalCell" class="fw-bold fs-5">—</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">更新數量</button>

      <form method="POST" action="{{ url_for('clear_cart') }}">
        <button type="submit" class="btn btn-outline-warning">清空購物車</button>
      </form>
    </div>
  </form>
  {% else %}
    <div class="alert alert-info">購物車是空的，去逛逛吧！</div>
  {% endif %}
</div>

<!-- ✅ 前端動態計算：只有勾選的才計入總金額；數量變動即時更新小計與合計 -->
<script>
  (function () {
    const body = document.getElementById('cartBody');
    if (!body) return;

    const checkAll = document.getElementById('checkAll');
    const totalCell = document.getElementById('totalCell');

    function formatCurrency(n) {
      return new Intl.NumberFormat('zh-TW').format(n) + ' 元';
    }

    function recalcRow(tr) {
      const price = parseInt(tr.getAttribute('data-price'), 10) || 0;
      const qtyInput = tr.querySelector('.qty-input');
      let qty = parseInt(qtyInput.value, 10) || 1;
      if (qty < 1) { qty = 1; qtyInput.value = 1; }
      const subtotal = price * qty;
      tr.querySelector('.subtotal-cell').textContent = formatCurrency(subtotal);
      return { subtotal, checked: tr.querySelector('.item-check').checked };
    }

    function recalcAll() {
      let total = 0;
      body.querySelectorAll('tr').forEach(tr => {
        const { subtotal, checked } = recalcRow(tr);
        if (checked) total += subtotal;
      });
      totalCell.textContent = formatCurrency(total);
    }

    // 事件：數量加減按鈕、輸入框、勾選框、全選
    body.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const tr = e.target.closest('tr');
      if (!tr) return;

      const qtyInput = tr.querySelector('.qty-input');
      let qty = parseInt(qtyInput.value, 10) || 1;

      if (btn.classList.contains('btn-inc')) {
        qtyInput.value = qty + 1;
        recalcAll();
      } else if (btn.classList.contains('btn-dec')) {
        qtyInput.value = Math.max(1, qty - 1);
        recalcAll();
      }
    });

    body.addEventListener('input', (e) => {
      if (e.target.classList.contains('qty-input')) {
        recalcAll();
      }
    });

    body.addEventListener('change', (e) => {
      if (e.target.classList.contains('item-check')) {
        recalcAll();
      }
    });

    if (checkAll) {
      checkAll.addEventListener('change', () => {
        const checked = checkAll.checked;
        body.querySelectorAll('.item-check').forEach(cb => cb.checked = checked);
        recalcAll();
      });
    }

    // 首次載入計算
    recalcAll();
  })();
</script>
{% endblock %}
