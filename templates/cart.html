{% extends "base.html" %}
{% block title %}è³¼ç‰©è»Š{% endblock %}

{% block content %}
<div class="container" style="margin-top: 90px">
  <h2>ğŸ›’ è³¼ç‰©è»Š</h2>

  {% if items %}
  <form id="updateForm" method="POST" action="{{ url_for('update_cart_qty') }}">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 120px;">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checkAll">
              <label class="form-check-label" for="checkAll">å…¨é¸</label>
            </div>
          </th>

          <th>å•†å“åç¨±</th>
          <th>å–®åƒ¹</th>
          <th style="width: 200px;">æ•¸é‡</th>
          <th>å°è¨ˆ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="cartBody">
        {% for item in items %}
        <tr data-price="{{ item.price|int }}">
          <td><input type="checkbox" class="item-check"></td>
          <td>{{ item.name }}</td>
          <td class="price-cell">{{ item.price|int }} å…ƒ</td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <input type="hidden" name="pid[]" value="{{ item.pid }}">
              <input type="number" name="qty[]" class="form-control qty-input"
                     value="{{ item.quantity|int }}" min="1" step="1" required style="max-width: 110px;">
              <button type="button" class="btn btn-outline-secondary btn-sm btn-dec">ï¼</button>
              <button type="button" class="btn btn-outline-secondary btn-sm btn-inc">ï¼‹</button>
            </div>
          </td>
          <td class="subtotal-cell fw-semibold">â€”</td>
          <td>
            <a href="{{ url_for('remove_from_cart', pid=item.pid) }}" class="btn btn-sm btn-danger">ç§»é™¤</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4" class="text-end fw-bold">å‹¾é¸é …ç›®åˆè¨ˆï¼š</td>
          <td id="totalCell" class="fw-bold fs-5">â€”</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    <!-- âŒ åŸæœ¬çš„ã€Œæ›´æ–°æ•¸é‡ã€æŒ‰éˆ•ç§»é™¤ï¼Œæ”¹ç‚ºè‡ªå‹•å„²å­˜ -->
  </form>

  <div class="mt-3 d-flex flex-wrap gap-2">
    <a href="{{ url_for('shop') }}" class="btn btn-outline-secondary">å›å•†åŸ</a>

    <form method="POST" action="{{ url_for('clear_cart') }}" class="d-inline">
      <button type="submit" class="btn btn-outline-warning">æ¸…ç©ºè³¼ç‰©è»Š</button>
    </form>

    <form id="checkoutForm" method="POST" action="{{ url_for('checkout') }}" class="d-inline">
      <button type="button" id="checkoutBtn" class="btn btn-success">çµå¸³</button>
    </form>
  </div>

  {% else %}
    <div class="alert alert-info">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œå»é€›é€›å§ï¼</div>
  {% endif %}
</div>

<script>
  (function () {
    const body = document.getElementById('cartBody');
    if (!body) return;

    const checkAll = document.getElementById('checkAll');
    const totalCell = document.getElementById('totalCell');
    const updateForm = document.getElementById('updateForm');

    function fmt(n){ return new Intl.NumberFormat('zh-TW').format(n) + ' å…ƒ'; }

    // è¨ˆç®—å–®åˆ—å°è¨ˆ
    function recalcRow(tr) {
      let price = parseInt(tr.getAttribute('data-price'), 10);
      if (!Number.isFinite(price) || price < 0) price = 0;

      const qtyInput = tr.querySelector('.qty-input');
      let qty = parseInt(qtyInput.value, 10);
      if (!Number.isFinite(qty) || qty < 1) { qty = 1; qtyInput.value = 1; }

      const subtotal = price * qty;
      tr.querySelector('.subtotal-cell').textContent = fmt(subtotal);
      return { subtotal, checked: tr.querySelector('.item-check').checked, qty };
    }

    // è¨ˆç®—ç¸½è¨ˆï¼ˆåªç®—å‹¾é¸çš„ï¼‰
    function recalcAll() {
      let total = 0;
      body.querySelectorAll('tr').forEach(tr => {
        const { subtotal, checked } = recalcRow(tr);
        if (checked) total += subtotal;
      });
      totalCell.textContent = fmt(total);
    }

    // æ›´æ–° offcanvas/é€£çµå¾½ç« ï¼ˆç”¨å‰ç«¯ç¾æœ‰æ•¸é‡åŠ ç¸½ï¼‰
    function updateCartBadge() {
      let sum = 0;
      body.querySelectorAll('.qty-input').forEach(i => {
        sum += Math.max(0, parseInt(i.value, 10) || 0);
      });
      const link = document.getElementById('cartLink');
      if (!link) return;
      let badge = link.querySelector('.cart-badge');
      if (sum <= 0) { if (badge) badge.remove(); return; }
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'ms-1 cart-badge';
        link.appendChild(badge);
      }
      badge.textContent = (sum <= 99) ? String(sum) : '99+';
      badge.classList.remove('pop'); void badge.offsetWidth; badge.classList.add('pop');
    }

    // ===== ç”¨ã€Œè¡¨å–®æäº¤ã€è€Œä¸æ˜¯ JSONï¼šå»æŠ– 500ms è‡ªå‹•é€å‡º =====
    let submitTimer = null;
    function debounceSubmit() {
      clearTimeout(submitTimer);
      submitTimer = setTimeout(() => {
        updateForm.submit();    // ç›´æ¥æäº¤æ•´å€‹ pid[] / qty[] è¡¨å–®
      }, 500);
    }

    // äº‹ä»¶ï¼šæ•¸é‡ +/- æŒ‰éˆ•
    body.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const tr = e.target.closest('tr');
      if (!tr) return;

      const qtyInput = tr.querySelector('.qty-input');
      let qty = parseInt(qtyInput.value, 10) || 1;

      if (btn.classList.contains('btn-inc')) qty = qty + 1;
      if (btn.classList.contains('btn-dec')) qty = Math.max(1, qty - 1);

      qtyInput.value = qty;
      recalcAll();
      updateCartBadge();
      debounceSubmit();
    });

    // äº‹ä»¶ï¼šæ‰‹å‹•è¼¸å…¥æ•¸é‡ï¼ˆè‡ªå‹•é€å‡ºï¼‰
    body.addEventListener('input', (e) => {
      if (!e.target.classList.contains('qty-input')) return;
      let qty = parseInt(e.target.value, 10) || 1;
      if (qty < 1) qty = 1;
      e.target.value = qty;
      recalcAll();
      updateCartBadge();
      debounceSubmit();
    });

    // å‹¾é¸è®Šå‹•
    body.addEventListener('change', (e) => {
      if (e.target.classList.contains('item-check')) {
        recalcAll();
        const items = [...body.querySelectorAll('.item-check')];
        const allOn = items.length > 0 && items.every(cb => cb.checked);
        if (checkAll) checkAll.checked = allOn;
      }
    });

    // å…¨é¸
    checkAll?.addEventListener('change', () => {
      const checked = checkAll.checked;
      body.querySelectorAll('.item-check').forEach(cb => cb.checked = checked);
      recalcAll();
    });

    // çµå¸³ï¼šåªæäº¤å‹¾é¸çš„ pid/qty
    const checkoutBtn = document.getElementById('checkoutBtn');
    const checkoutForm = document.getElementById('checkoutForm');
    checkoutBtn?.addEventListener('click', () => {
      checkoutForm.querySelectorAll('input[type="hidden"]').forEach(i => i.remove());
      let count = 0;
      body.querySelectorAll('tr').forEach(tr => {
        if (!tr.querySelector('.item-check').checked) return;
        const pid = tr.querySelector('input[name="pid[]"]').value;
        const qty = tr.querySelector('.qty-input').value;

        const ip = document.createElement('input');
        ip.type = 'hidden'; ip.name = 'pid[]'; ip.value = pid;
        checkoutForm.appendChild(ip);

        const iq = document.createElement('input');
        iq.type = 'hidden'; iq.name = 'qty[]'; iq.value = qty;
        checkoutForm.appendChild(iq);

        count++;
      });
      if (count === 0) { alert('è«‹å…ˆå‹¾é¸è¦çµå¸³çš„å•†å“'); return; }
      checkoutForm.submit();
    });

    // åˆå§‹è¨ˆç®—
    recalcAll();
    updateCartBadge();
  })();
</script>

{% endblock %}
