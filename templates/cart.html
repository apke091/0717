{% extends "base.html" %}
{% block title %}購物車{% endblock %}

{% block content %}
<div class="container" style="margin-top: 90px">
  <h2>🛒 購物車</h2>

  {% if items %}
  <form id="updateForm" method="POST" action="{{ url_for('update_cart_qty') }}">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 120px;">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checkAll">
              <label class="form-check-label" for="checkAll">全選</label>
            </div>
          </th>

          <th>商品名稱</th>
          <th>單價</th>
          <th style="width: 200px;">數量</th>
          <th>小計</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="cartBody">
        {% for item in items %}
        <tr data-price="{{ item.price|int }}">
          <td><input type="checkbox" class="item-check"></td>
          <td>{{ item.name }}</td>
          <td class="price-cell">{{ item.price|int }} 元</td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <input type="hidden" name="pid[]" value="{{ item.pid }}">
              <input type="number" name="qty[]" class="form-control qty-input"
                     value="{{ item.quantity|int }}" min="1" step="1" required style="max-width: 110px;">
              <button type="button" class="btn btn-outline-secondary btn-sm btn-dec">－</button>
              <button type="button" class="btn btn-outline-secondary btn-sm btn-inc">＋</button>
            </div>
          </td>
          <td class="subtotal-cell fw-semibold">—</td>
          <td>
            <a href="{{ url_for('remove_from_cart', pid=item.pid) }}" class="btn btn-sm btn-danger">移除</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4" class="text-end fw-bold">勾選項目合計：</td>
          <td id="totalCell" class="fw-bold fs-5">—</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    <!-- ❌ 原本的「更新數量」按鈕移除，改為自動儲存 -->
  </form>

  <div class="mt-3 d-flex flex-wrap gap-2">
    <a href="{{ url_for('shop') }}" class="btn btn-outline-secondary">回商城</a>

    <form method="POST" action="{{ url_for('clear_cart') }}" class="d-inline">
      <button type="submit" class="btn btn-outline-warning">清空購物車</button>
    </form>

    <form id="checkoutForm" method="POST" action="{{ url_for('checkout') }}" class="d-inline">
      <button type="button" id="checkoutBtn" class="btn btn-success">結帳</button>
    </form>
  </div>

  {% else %}
    <div class="alert alert-info">購物車是空的，去逛逛吧！</div>
  {% endif %}
</div>

<script>
  (function () {
    const body = document.getElementById('cartBody');
    if (!body) return;

    const checkAll = document.getElementById('checkAll');
    const totalCell = document.getElementById('totalCell');
    const updateForm = document.getElementById('updateForm');

    function fmt(n){ return new Intl.NumberFormat('zh-TW').format(n) + ' 元'; }

    // 計算單列小計
    function recalcRow(tr) {
      let price = parseInt(tr.getAttribute('data-price'), 10);
      if (!Number.isFinite(price) || price < 0) price = 0;

      const qtyInput = tr.querySelector('.qty-input');
      let qty = parseInt(qtyInput.value, 10);
      if (!Number.isFinite(qty) || qty < 1) { qty = 1; qtyInput.value = 1; }

      const subtotal = price * qty;
      tr.querySelector('.subtotal-cell').textContent = fmt(subtotal);
      return { subtotal, checked: tr.querySelector('.item-check').checked, qty };
    }

    // 計算總計（只算勾選的）
    function recalcAll() {
      let total = 0;
      body.querySelectorAll('tr').forEach(tr => {
        const { subtotal, checked } = recalcRow(tr);
        if (checked) total += subtotal;
      });
      totalCell.textContent = fmt(total);
    }

    // 更新 offcanvas/連結徽章（用前端現有數量加總）
    function updateCartBadge() {
      let sum = 0;
      body.querySelectorAll('.qty-input').forEach(i => {
        sum += Math.max(0, parseInt(i.value, 10) || 0);
      });
      const link = document.getElementById('cartLink');
      if (!link) return;
      let badge = link.querySelector('.cart-badge');
      if (sum <= 0) { if (badge) badge.remove(); return; }
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'ms-1 cart-badge';
        link.appendChild(badge);
      }
      badge.textContent = (sum <= 99) ? String(sum) : '99+';
      badge.classList.remove('pop'); void badge.offsetWidth; badge.classList.add('pop');
    }

    // ===== 用「表單提交」而不是 JSON：去抖 500ms 自動送出 =====
    let submitTimer = null;
    function debounceSubmit() {
      clearTimeout(submitTimer);
      submitTimer = setTimeout(() => {
        updateForm.submit();    // 直接提交整個 pid[] / qty[] 表單
      }, 500);
    }

    // 事件：數量 +/- 按鈕
    body.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const tr = e.target.closest('tr');
      if (!tr) return;

      const qtyInput = tr.querySelector('.qty-input');
      let qty = parseInt(qtyInput.value, 10) || 1;

      if (btn.classList.contains('btn-inc')) qty = qty + 1;
      if (btn.classList.contains('btn-dec')) qty = Math.max(1, qty - 1);

      qtyInput.value = qty;
      recalcAll();
      updateCartBadge();
      debounceSubmit();
    });

    // 事件：手動輸入數量（自動送出）
    body.addEventListener('input', (e) => {
      if (!e.target.classList.contains('qty-input')) return;
      let qty = parseInt(e.target.value, 10) || 1;
      if (qty < 1) qty = 1;
      e.target.value = qty;
      recalcAll();
      updateCartBadge();
      debounceSubmit();
    });

    // 勾選變動
    body.addEventListener('change', (e) => {
      if (e.target.classList.contains('item-check')) {
        recalcAll();
        const items = [...body.querySelectorAll('.item-check')];
        const allOn = items.length > 0 && items.every(cb => cb.checked);
        if (checkAll) checkAll.checked = allOn;
      }
    });

    // 全選
    checkAll?.addEventListener('change', () => {
      const checked = checkAll.checked;
      body.querySelectorAll('.item-check').forEach(cb => cb.checked = checked);
      recalcAll();
    });

    // 結帳：只提交勾選的 pid/qty
    const checkoutBtn = document.getElementById('checkoutBtn');
    const checkoutForm = document.getElementById('checkoutForm');
    checkoutBtn?.addEventListener('click', () => {
      checkoutForm.querySelectorAll('input[type="hidden"]').forEach(i => i.remove());
      let count = 0;
      body.querySelectorAll('tr').forEach(tr => {
        if (!tr.querySelector('.item-check').checked) return;
        const pid = tr.querySelector('input[name="pid[]"]').value;
        const qty = tr.querySelector('.qty-input').value;

        const ip = document.createElement('input');
        ip.type = 'hidden'; ip.name = 'pid[]'; ip.value = pid;
        checkoutForm.appendChild(ip);

        const iq = document.createElement('input');
        iq.type = 'hidden'; iq.name = 'qty[]'; iq.value = qty;
        checkoutForm.appendChild(iq);

        count++;
      });
      if (count === 0) { alert('請先勾選要結帳的商品'); return; }
      checkoutForm.submit();
    });

    // 初始計算
    recalcAll();
    updateCartBadge();
  })();
</script>

{% endblock %}
